# Copyright 2020 Energinet DataHub A/S
#
# Licensed under the Apache License, Version 2.0 (the "License2");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: CD

on:
  push:
    branches:
      - main
      - kerbou/997-publish-test-report-cd

jobs:
  #
  # Detect changes to start relevant jobs
  #

  changes:
    uses: ./.github/workflows/detect-changes.yml

  #
  # CD .NET
  #

  dotnet_update_coverage_report:
    needs: changes
    if: ${{ needs.changes.outputs.dotnet == 'true' }}
    uses: Energinet-DataHub/.github/.github/workflows/dotnet-solution-ci.yml@997/publish-test-results
    with:
      solution_file_path: source/EDI.sln
      tests_filter_expression: FullyQualifiedName!~LearningTests # Filter => Skip all tests within namespace 'LearningTests'
      use_sqllocaldb_2019: true
      environment: AzureAuth
      dotnet_version: 7.0.200

  # dotnet_promote_prerelease:
  #   needs: changes
  #   if: ${{ needs.changes.outputs.dotnet == 'true' }}
  #   uses: Energinet-DataHub/.github/.github/workflows/promote-prerelease.yml@v10
  #   with:
  #     release_name_prefix: dotnet

  # #
  # # Dispatch deployment request
  # #

  # dispatch_deploment_event:
  #   runs-on: ubuntu-latest
  #   needs: dotnet_promote_prerelease
  #   steps:
  #     - name: Find associated pull request
  #       uses: Energinet-DataHub/.github/.github/actions/find-related-pr-number@v10
  #       id: find_pull_request

  #     - name: Repository Dispatch
  #       uses: peter-evans/repository-dispatch@v2
  #       with:
  #         token: ${{ secrets.pat_token }}
  #         repository: ${{ secrets.environment_repository_path }}
  #         event-type: edi-deployment-request-domain
  #         client-payload: '{"domain_pr": "${{ steps.find_pull_request.outputs.pull_request_number }}"}' # yamllint disable-line rule:quoted-strings

  # #
  # # Send notification to teams channel if deployment dispatch failed
  # #

  # dispatch_failed:
  #   needs: [dotnet_promote_prerelease, dispatch_deploment_event]
  #   if: |
  #     always() &&
  #     contains(needs.*.result, 'failure')
  #   uses: Energinet-DataHub/.github/.github/workflows/notify-team.yml@v10
  #   with:
  #     team_name: Batman
  #     subject: "Deployment dispatch failed: EDI"
  #   secrets: inherit
